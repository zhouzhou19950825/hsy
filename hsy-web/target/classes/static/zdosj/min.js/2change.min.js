/**
 * Created by zhubuqing on 2017/12/20.
 */
var getAllTableHeadNodeByMenuNodeIdUrl = "/tableHeadNode/getAllTableHeadNodeByMenuNodeId";
var updateTableHeadNodeUrl = "/tableHeadNode/updateTableHeadNode";
var getAreaTableByMenuNodeIdUrl = "/areaTable/getAreaTableByMenuNodeId";
var getCountryByAreaIdUrl = "/country/getCountryByAreaId";
var getAreaTableDataByCountryIdAndTableHeadNodeIdUrl = "/areaTableData/getAreaTableDataByCountryIdAndTableHeadNodeId";

var areaId = 1;

var pList = new Array();

var dataMap = {};
function dataFormatter(obj) {
    var temp;
    var max = 0;
    for (var i = 0; i < leafNodesWithOutArea.length; i++) {
        var tempKey = leafNodesWithOutArea[i].headNodeName;
        temp = obj[leafNodesWithOutArea[i].headNodeName];
        for (var j = 0, l = temp.length; j < l; j++) {
            max = Math.max(max, temp[j]);
            obj[leafNodesWithOutArea[i].headNodeName][j] = {
                name: pList[j],
                value: temp[j]
            }
        }
        obj[leafNodesWithOutArea[i].headNodeName + 'max'] = Math.floor(max / 100) * 100;
    }
    return obj;
}

var myDataMap = "";

var reg = /[\u4e00-\u9fa5]/g;


var menuNodeId = 0;


var headNodes = new Array();


var leafNodes = new Array();


var leafNodesWithOutArea = new Array();

var text = "";

var json = "";


var notLeafNodes = new Array();


var deepestNodeLevel = 0;


var countries = "";

var myMax = 0;

var countryTableHeadNode = {
    id: -1,
    headNodeName: "国家或地区",
    fatherId: 0,
    level: 1,
    isLeaf: 1,
    myGroup: 0,
    height: 1,
    weight: 1,
    menuNodeId: menuNodeId,
    isParent: false
};

var areaId = 1;

var tableData = new Array();

$(function () {
    menuNodeId = getParams("menuNodeId");
    showAreaTable(menuNodeId);
    addAreaTableData();

    getLeafNodesWithOutArea();


    addMyDataMap();

    var myDataMapJson = JSON.parse(myDataMap);

    dataMap.dataGDP = dataFormatter(myDataMapJson);

    pushNewDataInOption();
})

function getLeafNodesWithOutArea() {
    for (var i = 0; i < leafNodes.length; i++) {
        if (leafNodes[i].id != -1) {
            leafNodesWithOutArea.push(leafNodes[i]);
        }
    }

    for (var i = 0; i < leafNodesWithOutArea.length; i++) {
        if (i == 0) {

            text += '[{"NAME":"' + leafNodesWithOutArea[i].headNodeName + '"}';
        } else if (i == leafNodesWithOutArea.length - 1) {

            text += ',{"NAME":"' + leafNodesWithOutArea[i].headNodeName + '"}]';
        } else {

            text += ',{"NAME":"' + leafNodesWithOutArea[i].headNodeName + '"}';
        }
    }

    json = JSON.parse(text);
}

function addMyDataMap() {
    for (var i = 0; i < leafNodesWithOutArea.length; i++) {
        if (i == 0) {

            myDataMap = '{"' + leafNodesWithOutArea[i].headNodeName + '":[';
        } else {

            myDataMap += '"' + leafNodesWithOutArea[i].headNodeName + '":[';
        }
        var k = 0;
        for (var j = 0; j < tableData.length; j++) {
            if (tableData[j].tableHeadNodeId == leafNodesWithOutArea[i].id) {
                if (k == 0) {
                    myDataMap += tableData[j].content;
                    if (parseInt(tableData[j].content) > myMax) {
                        myMax = tableData[j].content;
                    }
                } else {
                    myDataMap += "," + tableData[j].content;
                    if (parseInt(tableData[j].content) > myMax) {
                        myMax = tableData[j].content;
                    }
                }
                k++;
            }
        }
        if (i == leafNodesWithOutArea.length - 1) {

            myDataMap += ']}';
        } else {

            myDataMap += '],';
        }
    }
}

function pushNewDataInOption() {
    addCharts();
}

function addCharts() {
    require.config({
        paths: {
            echarts: 'http:
        }
    });
    require(
        [
            'echarts',
            'echarts/chart/line',
            'echarts/chart/bar'
        ],
        function (ec) {
            var myChart = ec.init(document.getElementById('main'));


            option = {
                timeline: {
                    data: (function () {
                        var data = [];
                        for (var i = 0; i < json.length; i++) {
                            data.push(json[i].NAME.replace(reg, ""));

                            console.log(json[i].NAME);
                        }
                        return data;
                    })(),
                    autoPlay: true,
                    playInterval: 1000
                },
                options: (function () {
                    var options = [];
                    for (var i = 0; i < json.length; i++) {
                        if (i == 0) {
                            options.push({
                                title: {
                                    'text': json[0].NAME,
                                    'subtext': ''
                                },
                                tooltip: {'trigger': 'axis'},
                                legend: {
                                    x: 'right',
                                    'data': ['数据'],
                                    'selected': {
                                        'GDP': true
                                    }
                                },
                                toolbox: {
                                    'show': true,
                                    orient: 'vertical',
                                    x: 'right',
                                    y: 'center',
                                    'feature': {
                                        'mark': {'show': true},
                                        'dataView': {'show': true, 'readOnly': false},
                                        'magicType': {'show': true, 'type': ['line', 'bar', 'stack', 'tiled']},
                                        'restore': {'show': true},
                                        'saveAsImage': {'show': true}
                                    }
                                },
                                calculable: true,
                                grid: {'y': 80, 'y2': 100},
                                xAxis: [{
                                    'type': 'category',
                                    'axisLabel': {'interval': 0},
                                    'data': pList
                                }],
                                yAxis: [
                                    {
                                        'type': 'value',
                                        'name': '',
                                        'max': myMax
                                    },
                                    {
                                        'type': 'value',
                                        'name': ''
                                    }
                                ],
                                series: [
                                    {
                                        'name': '数据',
                                        'type': 'line',
                                        'markLine': {
                                            symbol: ['arrow', 'none'],
                                            symbolSize: [4, 2],
                                            itemStyle: {
                                                normal: {
                                                    lineStyle: {color: 'blue'},
                                                    barBorderColor: 'blue',
                                                    label: {
                                                        position: 'left',
                                                        formatter: function (params) {
                                                            return Math.round(params.value);
                                                        },
                                                        textStyle: {color: 'blue'}
                                                    }
                                                }
                                            },
                                            'data': [{'type': 'average', 'name': '平均值'}]
                                        },
                                        'data': dataMap.dataGDP[json[0].NAME]
                                    }
                                ]

                            });
                        } else {
                            var year = json[i].NAME;
                            options.push({
                                title: {'text': year},
                                series: [
                                    {'data': dataMap.dataGDP[year]}
                                ]

                            });
                        }
                    }
                    return options;
                })()
            };
            myChart.setOption(option);
        }
    );
}

function getParams(key) {
    var reg = new RegExp("(^|&)" + key + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) {
        return unescape(r[2]);
    }
    return null;
}


function isLeaf(leaf) {
    return (leaf == 0 ? true : false);
}

function showAreaTable(menuNodeId) {
    getAreaTableByMenuNodeId(menuNodeId);
    buildTableHeadNodeByAreaTableId();
}


function getAreaTableByMenuNodeId(menuNodeId) {
    $.ajax({
        type: "GET",
        url: getAreaTableByMenuNodeIdUrl,
        data: {
            menuNodeId: menuNodeId
        },
        beforeSend: function (XMLHttpRequest) {
        },
        success: function (result) {
            if (result != null) {
                var htmls = ""

                htmls += result.areaTableName + " 柱状图<br>";

                htmls += "<p>" + result.areaTableEnglishName + "</p>";

                $("#areaTableName").html(result.areaTableName);
                $("#areaTableNameCap").html(htmls);
                $("#areaTableEnglishName").html(result.areaTableEnglishName);


            }
        },
        complete: function (XMLHttpRequest, textStatus) {
        },
        error: function () {
        }
    });
}

function buildTableHeadNodeByAreaTableId() {
    getAllNodes();
    startBuild();
}

function startBuild() {

    init();


    setHeightAndWeight();


    setNodesMyGroup();


    sortMyNodes();


    generatingTable();
}


function sortMyNodes() {
    for (var i = 0; i < headNodes.length; i++) {
        for (var j = headNodes.length - 1; j > i; j--) {
            if (headNodes[j].myGroup < headNodes[j - 1].myGroup) {
                var temp = headNodes[j];
                headNodes[j] = headNodes[j - 1];
                headNodes[j - 1] = temp;
            }
        }
    }
}


function setNodesMyGroup() {
    for (var i = 0; i < deepestNodeLevel; i++) {
        var levelNodes = getLevelNodes(i);
        if (i === 0) {
            for (var j = 0; j < levelNodes.length; j++) {
                levelNodes[j].myGroup = j;
            }
        } else {
            for (var j = 0; j < levelNodes.length; j++) {
                var levelFatherNode = getNodeById(levelNodes[j].fatherId);
                levelNodes[j].myGroup = levelFatherNode.myGroup * 100 + j;
            }
        }
        updateHeadNodes(levelNodes);
    }
}


function getLevelNodes(level) {

    var levelNodes = new Array();

    for (var i = 0; i < headNodes.length; i++) {
        if (headNodes[i].level === (level + 1)) {
            levelNodes.push(headNodes[i]);
        }
    }

    return levelNodes;
}


function setHeightAndWeight() {

    setLeafNodeHeight();


    setNotLeafNodesWeight();
}


function setNotLeafNodesWeight() {
    for (var i = 0; i < notLeafNodes.length; i++) {
        var notLeafNodeWeight = 0;
        for (var j = 0; j < leafNodes.length; j++) {
            var middleNode = leafNodes[j];
            for (var k = 0; k < (leafNodes[j].level - notLeafNodes[i].level); k++) {
                middleNode = getNodeById(middleNode.fatherId);
            }
            if (middleNode.id === notLeafNodes[i].id) {
                notLeafNodeWeight++;
            }
        }
        notLeafNodes[i].weight = notLeafNodeWeight;
    }


    updateHeadNodes(notLeafNodes);
}


function getNodeById(fatherId) {
    for (var i = 0; i < headNodes.length; i++) {
        if (headNodes[i].id == fatherId) {
            return headNodes[i];
        }
    }
}


function setLeafNodeHeight() {
    for (var i = 0; i < leafNodes.length; i++) {
        if (leafNodes[i].level < deepestNodeLevel) {
            leafNodes[i].height = deepestNodeLevel - leafNodes[i].level + 1;
        }
    }
    updateHeadNodes(leafNodes);
}


function updateHeadNodes(myNodes) {
    for (var i = 0; i < myNodes.length; i++) {
        for (var j = 0; j < headNodes.length; j++) {
            if (myNodes[i].id === headNodes[j].id) {
                headNodes[j] = myNodes[i];
                break;
            }
        }
    }

    for (var i = 0; i < myNodes.length; i++) {
        if (myNodes[i].id !== -1) {
            updateTableHeadNode(myNodes[i]);
        }
    }
}


function updateTableHeadNode(myNode) {
    var a = myNode;
    $.ajax({
        type: "GET",
        url: updateTableHeadNodeUrl,
        async: false,
        data: {
            id: parseInt(myNode.id),
            isLeaf: isTheParent(myNode.isParent),
        },
        beforeSend: function (XMLHttpRequest) {
        },
        success: function (result) {
            if (result != null) {

            }
        },
        complete: function (XMLHttpRequest, textStatus) {
        },
        error: function () {
        }
    });
}


function init() {

    getLeafNodes();


    getDeep();


    getNotLeafNodes();
}


function getNotLeafNodes() {
    for (var i = 0; i < headNodes.length; i++) {
        if (headNodes[i].isLeaf != 1) {
            notLeafNodes.push(headNodes[i]);
        }
    }
}


function getLeafNodes() {
    for (var i = 0; i < headNodes.length; i++) {
        if (headNodes[i].isLeaf == 1) {
            leafNodes.push(headNodes[i]);
        }
    }
}


function getDeep() {
    for (var i = 0; i < leafNodes.length; i++) {
        if (leafNodes[i].level >= deepestNodeLevel) {
            deepestNodeLevel = leafNodes[i].level;
        }
    }
}


function getAllNodes() {
    $.ajax({
        type: "GET",
        url: getAllTableHeadNodeByMenuNodeIdUrl,
        async: false,
        data: {
            menuNodeId: menuNodeId
        },
        beforeSend: function (XMLHttpRequest) {
        },
        success: function (result) {
            if (result != null) {
                pushHeadNodes(result);
            }
        },
        complete: function (XMLHttpRequest, textStatus) {
        },
        error: function () {
        }
    });
}


function pushHeadNodes(result) {
    clearHeadNodes();
    for (var i = 0; i < result.length; i++) {
        var addCountryTableHeadNode = {
            id: result[i].id,
            headNodeName: result[i].tableHeadNodeName,
            fatherId: result[i].fatherId,
            level: result[i].level,
            isLeaf: result[i].isLeaf,
            myGroup: result[i].myGroup,
            height: result[i].height,
            weight: result[i].weight,
            menuNodeId: menuNodeId,
            isParent: isLeaf(result[i].isLeaf)
        }
        headNodes.push(addCountryTableHeadNode);
    }
}


function clearHeadNodes() {
    deepestNodeLevel = 0;
    leafNodes.splice(0, leafNodes.length);
    notLeafNodes.splice(0, notLeafNodes.length);
    headNodes.splice(0, headNodes.length);
    headNodes.push(countryTableHeadNode);
}


function generatingTable() {
    var myHtml = "";
    for (var i = 0; i < deepestNodeLevel; i++) {
        myHtml += "<tr>";
        var levelNodes = getLevelNodes(i);
        for (var j = 0; j < levelNodes.length; j++) {
            myHtml += "<th id='" + levelNodes[j].id + "' rowspan='" + levelNodes[j].height + "' colspan='" + levelNodes[j].weight + "'>" + levelNodes[j].headNodeName + "</th>";
        }
        myHtml += "</tr>";
    }
    $("#myTable").html(myHtml);
}

function isTheParent(parent) {
    var a = (parent === true);
    var b = (parent == true);
    return (parent == true ? 0 : 1);
}


function addAreaTableData() {

    getCountryByAreaId();

    var addTableHtml = "";

    for (var i = 0; i < countries.length; i++) {
        addTableHtml += "<tr><td id='" + countries[i].id + "'>" + countries[i].countryName + "</td>";
        for (var j = 0; j < leafNodes.length; j++) {
            if (leafNodes[j].id != -1) {
                addTableHtml += "<td id='" + countries[i].id + "_" + leafNodes[j].id + "'></td>";
            }
        }
        addTableHtml += "</tr>";
    }

    $("#myTableData").html(addTableHtml);


    for (var i = 0; i < countries.length; i++) {
        for (var j = 0; j < leafNodes.length; j++) {
            if (leafNodes[j].id != -1) {
                getAreaTableDataByCountryIdAndTableHeadNodeId(countries[i].id, leafNodes[j].id);
            }
        }
    }
}


function getAreaTableDataByCountryIdAndTableHeadNodeId(countryId, tableHeadNodeId) {
    $.ajax({
        type: "GET",
        url: getAreaTableDataByCountryIdAndTableHeadNodeIdUrl,
        async: false,
        data: {
            countryId: countryId,
            tableHeadNodeId: tableHeadNodeId,
            menuNodeId: menuNodeId
        },
        beforeSend: function (XMLHttpRequest) {
        },
        success: function (result) {
            $("#" + countryId + "_" + tableHeadNodeId).html(result.content);
            tableData.push(result);
        },
        complete: function (XMLHttpRequest, textStatus) {
        },
        error: function () {
        }
    });
}


function getCountryByAreaId() {
    $.ajax({
        type: "GET",
        url: getCountryByAreaIdUrl,
        async: false,
        data: {
            areaId: areaId
        },
        beforeSend: function (XMLHttpRequest) {
        },
        success: function (result) {
            if (result !== null) {
                countries = result;
                pushCountriesInOption();
            }
        },
        complete: function (XMLHttpRequest, textStatus) {
        },
        error: function () {
        }
    });
}


function pushCountriesInOption() {
    for (var i = 0; i < countries.length; i++) {
        pList.push(countries[i].countryName);
    }
}